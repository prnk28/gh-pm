version: '3'

vars:
  PROXY: package://pkg.pkl-lang.org/pkl-pantry
  NAME: org.json_schema.contrib
  VERSION: 1.1.3
  PKG: "{{.PROXY}}/{{.NAME}}@{{.VERSION}}#"

tasks:
  generate:
    aliases: [g]
    cmds:
      - defer: rm -rf types/base
      - task: mock-data
      - task: jsonpkl-issues.json
      - task: jsonpkl-prs.json
      - task: jsonpkl-projects.json
      - task: jsonpkl-releases.json
      - task: jsonpkl-user.json

  jsonpkl-*:
    vars:
      FILE: '{{index .MATCH 0}}'
    cmds:
      - task: schemagen-{{.FILE}}
      - task: pkljson-{{.FILE}}

  pkljson-*:
    vars:

      EVAL: "{{.PKG}}/generate.pkl -m ."
      INPUT: '{{index .MATCH 0}}'
      FILE:
        sh: basename {{.INPUT}}
      OUTPUT: types/models
    cmds:
      - pkl eval {{.EVAL}} -p source=types/schemas/{{.INPUT}}
      - mkdir -p {{.OUTPUT}}
      - mv *.pkl {{.OUTPUT}}

  schemagen-*:
    vars:
      INPUT: '{{index .MATCH 0}}'
      FILE:
        sh: basename {{.INPUT}}
      OUTPUT: "{{.FILE}}"
    cmds:
      - json-schema-generator -f types/base/{{.INPUT}} -o types/schemas/{{.OUTPUT}}

      
  mock-data:
    cmds:
      - mkdir -p types/base
      - gh issue ls --repo=coindotfi/coind --json "author" --json "body" --json "id" --json "title" --json "number" --json "projectItems" --json "state" --json "title" --json "url" > types/base/issues.json
      - gh project ls --owner=onsonr --format json > types/base/projects.json
      - gh api user > types/base/user.json
      - gh pr ls --json "id" --json "title" --json "headRefName" --json "createdAt" --json "author" --json "number" > types/base/prs.json
      - gh release list --repo onsonr/sonr --json "name" --json "tagName" --json "publishedAt" --json "isDraft" --json "isLatest" > types/base/releases.json
      - |
        gh api graphql -f query='
          query($owner: String!, $repo: String!) {
            repository(owner: $owner, name: $repo) {
              milestones(first: 100) {
                nodes {
                  title
                  state
                  dueOn
                  progressPercentage
                  number
                  issues(first: 0) {
                    totalCount
                  }
                }
              }
            }
          }
        ' -F owner=onsonr -F repo=sonr > types/base/milestones.json


